@{
    ViewData["Title"] = "Signalr Demo";
}

<div id="pageContent">
    <template>
        <div class="row">
            <div class="col-sm-4">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#project" role="tab" aria-controls="home" aria-selected="true">项目中心&nbsp;<span class="badge badge-danger">{{project.tipCount}}</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#chat" role="tab" aria-controls="profile" aria-selected="false">聊天&nbsp;<span class="badge badge-danger">{{chat.tipCount}}</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#logout" role="tab" aria-controls="contact" aria-selected="false">登录互斥</a>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="project" role="tabpanel" aria-labelledby="home-tab">
                        <div class="card-body">
                            <button class="btn btn-primary" type="button">模拟分配责任人</button>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="chat" role="tabpanel" aria-labelledby="profile-tab">

                    </div>
                    <div class="tab-pane fade" id="logout" role="tabpanel" aria-labelledby="contact-tab">

                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            当前用户:{{userInfo.userName}} - 加入的组:{{userInfo.groups}} - 连接Id:{{userInfo.connectionId}}
                        </div>
                    </div>
                    <textarea id="logs" rows="20" class="form-control">{{logs.join('\r\n')}}</textarea>
                </div>
            </div>
        </div>
    </template>
    <div class="modal fade" id="collectionUserInfo" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">请输入连接的组</h5>
                </div>
                <div class="modal-body">
                    <form id="formInfo">
                        <div class="form-group">
                            <label for="message-text" class="col-form-label">组:</label>
                            <textarea autocomplete="off" placeholder="多个以,隔开" required class="form-control" id="groups"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" data-dismiss="modal">连接到服务器</button>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts{

    <script src="~/js/initSignalr.js" asp-append-version="true"></script>
    <script>
        $(function () {
            var vm = new Vue({
                el: '#pageContent',
                data: {
                    // 用户信息
                    userInfo: {
                        userName: '@User.Identity.Name',
                        groups: '',
                        connectId:''
                    },
                    // 日志
                    logs: [],
                    // 项目信息
                    project: {
                        tipCount: 0, // 提示数量
                    },
                    // 聊天
                    chat: {
                        tipCount: 0, // 提示数量
                    },
                    // 登录互斥
                    logout: {

                    }
                },
                methods: {

                },
                mounted: function () {
                     initConnect();
                    //testInitConnect();
                }
            })

            function testInitConnect() {
                initSignalr({
                    delay: 0,
                    url: 'http://localhost:50001/notify-hub?userId=xiexingen&group=AAA,BBB',
                    loggingLevel: signalR.LogLevel.Error,
                    onNotify: function (data) {
                        $logs.val($logs.val() + '\r\nOnNotify..........' + JSON.stringify(data));
                    },
                    onStarted: function () {
                        vm.$set(vm.userInfo, 'userName','xiexingen');
                        vm.$set(vm.userInfo, 'groups','AAA,BBB');
                        vm.logs.push('连接成功');
                    }
                });
            }

            function initConnect() {
                $("#collectionUserInfo").modal({
                    keyboard: false,
                    show: true,
                    backdrop: 'static'
                })

                $('#collectionUserInfo').on('hidden.bs.modal', function (event) {
                    // var modal = $(this);
                    var groups = $("#groups").val()||'';
                    var connect=initSignalr({
                        delay: 0,
                        url: 'http://localhost:50001/notify-hub?userId=' + vm.userInfo.userName + '&group=' + groups,
                        loggingLevel: signalR.LogLevel.Error,
                        onNotify: function (data) {
                            $logs.val($logs.val() + '\r\nOnNotify..........' + JSON.stringify(data));
                        },
                        onStarted: function () {
                            vm.$set(vm.userInfo, 'connectionId', connect.connectionId);
                            vm.$set(vm.userInfo, 'groups', groups);
                            vm.logs.push('连接成功');
                        }
                    });
                })
            }
        })
    </script>
}
